<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>í‹±íƒí†  ê²Œì„</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        button {
            width: 80px; height: 80px; font-size: 32px;
            margin: 5px; cursor: pointer;
        }
        .row { display: flex; justify-content: center; }
        #info { margin-top: 20px; font-size: 18px; }
    </style>
</head>
<body>
<h2>ğŸŸ¢ í‹±íƒí†  WebSocket ê²Œì„</h2>
<div id="board"></div>
<div id="info">í”Œë ˆì´ì–´ ì„ íƒ ì¤‘...</div>

<script>
    const board = new Array(9).fill(" ");
    let player = null;
    while (player !== "O" && player !== "X") {
        player = prompt("í”Œë ˆì´ì–´ ë§ˆí¬ë¥¼ ì„ íƒí•˜ì„¸ìš” (O / X)");
        if (player) player = player.toUpperCase();
    }

    let stompClient = null;
    let gameOver = false;
    const infoDiv = document.getElementById("info");

    function connect() {
        const socket = new SockJS("http://localhost:8080/tic");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            stompClient.subscribe("/topic/board", function (msg) {
                const data = JSON.parse(msg.body);
                for (let i = 0; i < 9; i++) {
                    board[i] = data.board[i] || " ";
                }
                render(data.nextTurn, data.result);
            });

            // âœ… ì ‘ì† í›„ ì„œë²„ì— ì´ˆê¸° ìƒíƒœ ìš”ì²­
            stompClient.send("/app/init", {}, {});
        });
    }

    function render(nextTurn, result) {
        const boardDiv = document.getElementById("board");
        boardDiv.innerHTML = "";
        for (let i = 0; i < 3; i++) {
            const row = document.createElement("div");
            row.className = "row";
            for (let j = 0; j < 3; j++) {
                const idx = i * 3 + j;
                const btn = document.createElement("button");
                btn.textContent = board[idx];
                btn.disabled = gameOver || board[idx] !== " " || player !== nextTurn;
                btn.onclick = () => {
                    stompClient.send("/app/move", {}, JSON.stringify({ position: idx, player }));
                };
                row.appendChild(btn);
            }
            boardDiv.appendChild(row);
        }

        if (result) {
            gameOver = true;
            if (result === "DRAW") {
                infoDiv.textContent = "ğŸ˜ ë¬´ìŠ¹ë¶€ì…ë‹ˆë‹¤.";
            } else if (result === "WIN_" + player) {
                infoDiv.textContent = "ğŸ‰ ë‹¹ì‹ ì´ ì´ê²¼ìŠµë‹ˆë‹¤!";
            } else if (result === "WIN_" + (player === "O" ? "X" : "O")) {
                infoDiv.textContent = "ğŸ˜¢ ë‹¹ì‹ ì´ ì¡ŒìŠµë‹ˆë‹¤!";
            } else if (result === "GAME_OVER") {
                infoDiv.textContent = "â›” ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            setTimeout(() => location.reload(), 5000);
        } else {
            infoDiv.textContent = `ë‹¹ì‹ ì€ ${player}ì…ë‹ˆë‹¤. í˜„ì¬ ${nextTurn}ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤.`;
        }
    }

    connect(); // âœ… ì˜¤ì§ ì´ connect() í•¨ìˆ˜ í•œ ë²ˆë§Œ í˜¸ì¶œ
</script>

</body>
</html>
