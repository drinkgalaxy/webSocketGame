<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>틱택토 게임</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        button {
            width: 80px; height: 80px; font-size: 32px;
            margin: 5px; cursor: pointer;
        }
        .row { display: flex; justify-content: center; }
        #info { margin-top: 20px; font-size: 18px; }
    </style>
</head>
<body>
<h2>🟢 틱택토 WebSocket 게임</h2>
<div id="board"></div>
<div id="info">플레이어 선택 중...</div>

<script>
    const board = new Array(9).fill(" ");
    let player = null;
    while (player !== "O" && player !== "X") {
        player = prompt("플레이어 마크를 선택하세요 (O / X)");
        if (player) player = player.toUpperCase();
    }

    let stompClient = null;
    let gameOver = false;
    const infoDiv = document.getElementById("info");

    function connect() {
        const socket = new SockJS("http://localhost:8080/tic");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            stompClient.subscribe("/topic/board", function (msg) {
                const data = JSON.parse(msg.body);
                for (let i = 0; i < 9; i++) {
                    board[i] = data.board[i] || " ";
                }
                render(data.nextTurn, data.result);
            });

            // ✅ 접속 후 서버에 초기 상태 요청
            stompClient.send("/app/init", {}, {});
        });
    }

    function render(nextTurn, result) {
        const boardDiv = document.getElementById("board");
        boardDiv.innerHTML = "";
        for (let i = 0; i < 3; i++) {
            const row = document.createElement("div");
            row.className = "row";
            for (let j = 0; j < 3; j++) {
                const idx = i * 3 + j;
                const btn = document.createElement("button");
                btn.textContent = board[idx];
                btn.disabled = gameOver || board[idx] !== " " || player !== nextTurn;
                btn.onclick = () => {
                    stompClient.send("/app/move", {}, JSON.stringify({ position: idx, player }));
                };
                row.appendChild(btn);
            }
            boardDiv.appendChild(row);
        }

        if (result) {
            gameOver = true;
            if (result === "DRAW") {
                infoDiv.textContent = "😐 무승부입니다.";
            } else if (result === "WIN_" + player) {
                infoDiv.textContent = "🎉 당신이 이겼습니다!";
            } else if (result === "WIN_" + (player === "O" ? "X" : "O")) {
                infoDiv.textContent = "😢 당신이 졌습니다!";
            } else if (result === "GAME_OVER") {
                infoDiv.textContent = "⛔ 게임이 종료되었습니다.";
            }
            setTimeout(() => location.reload(), 5000);
        } else {
            infoDiv.textContent = `당신은 ${player}입니다. 현재 ${nextTurn}의 차례입니다.`;
        }
    }

    connect(); // ✅ 오직 이 connect() 함수 한 번만 호출
</script>

</body>
</html>
